# 手动调整功能故障排除指南

## 问题：勾选手动调整后页面刷新导致状态丢失

### 问题分析
1. 用户勾选"手调"复选框
2. API调用成功，后端数据已更新
3. 页面自动刷新，但勾选状态消失

### 根本原因
- 在API调用完成后立即刷新页面会导致竞态条件
- 数据可能还没有完全持久化到数据库就开始读取
- 刷新操作覆盖了刚刚更新的本地状态

### 解决方案

#### 1. 移除自动刷新
- 删除了`refreshEntryData`函数调用
- API调用成功后只更新本地状态，不刷新整个数据
- 依赖本地状态管理而不是频繁的服务器同步

#### 2. 优化状态管理
```javascript
// 正确的做法：更新本地状态
const newDeductions = [...deductions];
const newItem = newDeductions[index];
newItem.is_manual = response.data.is_manual;
newItem.manual_at = response.data.manual_at;
// ... 其他字段
setDeductions(newDeductions);

// 错误的做法：立即刷新数据
// setTimeout(() => refreshEntryData(), 100);
```

#### 3. 调试步骤
1. 打开浏览器控制台
2. 查看以下日志：
   - `📤 [手动调整] 发送请求:` - 请求参数
   - `📥 [手动调整] API响应:` - 服务器响应
   - `✅ [手动调整] 更新后的本地状态:` - 本地状态更新
   - `🔍 [手动调整] 五险一金状态:` - 页面加载时的状态

### 验证步骤

#### 测试场景1：新勾选手动调整
1. 打开工资编辑模态框
2. 找到住房公积金字段
3. 勾选"手调"复选框
4. 观察：
   - 成功提示"已标记为手动调整"
   - 复选框保持勾选状态
   - 不应该有页面刷新

#### 测试场景2：修改手动调整金额
1. 在已勾选的字段中修改金额
2. 等待500ms（防抖延迟）
3. 观察控制台日志确认API调用
4. 金额应该正确保存

#### 测试场景3：页面重新加载
1. 设置手动调整后关闭模态框
2. 重新打开同一条记录
3. 验证手动调整状态是否保持

### 常见问题

#### Q: 为什么勾选后状态会丢失？
A: 可能的原因：
- 父组件触发了数据重新加载
- API调用还未完成就刷新了数据
- 本地状态没有正确更新

#### Q: 如何确认数据是否保存到数据库？
A: 查看后端日志：
```
手动调整成功: entry_id=3540, component=HOUSING_FUND_PERSONAL, original=3376, adjusted=3376, user=admin
```

#### Q: 页面刷新后状态不显示怎么办？
A: 检查数据加载日志：
```
🔍 [手动调整] 五险一金状态: {
  HOUSING_FUND_PERSONAL: {
    amount: 3376,
    is_manual: true,
    auto_calculated: 3300,
    manual_at: "2025-01-24T15:30:00"
  }
}
```

### 最佳实践
1. 不要在API调用后立即刷新数据
2. 使用本地状态管理减少服务器请求
3. 只在必要时（如提交表单）才同步服务器数据
4. 添加充分的调试日志便于问题排查