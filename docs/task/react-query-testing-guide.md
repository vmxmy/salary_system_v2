# React Query 功能测试指南

## 🎯 测试目标

验证 PayrollDataModal 组件中 React Query 集成的以下功能：
1. 数据缓存机制
2. 智能重试逻辑
3. 加载状态管理
4. 错误处理
5. 开发工具集成

## 📋 测试步骤

### 1. 基础功能测试

#### 步骤 1.1：访问应用
1. 打开浏览器，访问 `http://localhost:5173/`
2. 使用账号 `admin/admin` 登录
3. 导航到薪资管理相关页面

#### 步骤 1.2：打开薪资数据模态框
1. 找到薪资期间列表或相关入口
2. 点击"查看薪资数据"或类似按钮
3. 观察模态框打开过程

**预期结果**：
- ✅ 模态框正常打开
- ✅ 显示加载状态（loading spinner）
- ✅ 数据正常加载并显示

### 2. 缓存机制测试

#### 步骤 2.1：首次加载
1. 打开薪资数据模态框
2. 记录数据加载时间（通过浏览器开发者工具 Network 面板）
3. 关闭模态框

#### 步骤 2.2：缓存命中测试
1. 立即重新打开同一个薪资数据模态框
2. 观察加载时间和网络请求

**预期结果**：
- ✅ 第二次打开速度明显更快（< 100ms）
- ✅ Network 面板显示无新的 API 请求
- ✅ 数据立即显示，无加载状态

#### 步骤 2.3：缓存过期测试
1. 等待 5 分钟（超过 staleTime）
2. 重新打开薪资数据模态框
3. 观察是否触发后台数据更新

**预期结果**：
- ✅ 立即显示缓存数据
- ✅ 后台发起新的 API 请求更新数据
- ✅ 数据更新后界面自动刷新

### 3. React Query DevTools 测试

#### 步骤 3.1：打开开发工具
1. 在页面右下角查找 React Query DevTools 图标
2. 点击打开 DevTools 面板

#### 步骤 3.2：观察查询状态
1. 打开薪资数据模态框
2. 在 DevTools 中观察查询状态变化
3. 查看缓存的查询键和数据

**预期结果**：
- ✅ DevTools 正常显示
- ✅ 可以看到 `payrollData` 相关的查询
- ✅ 查询状态正确显示（loading → success）
- ✅ 缓存数据可见

### 4. 错误处理测试

#### 步骤 4.1：网络错误模拟
1. 打开浏览器开发者工具
2. 切换到 Network 面板
3. 启用"Offline"模式或设置网络节流
4. 尝试打开薪资数据模态框

**预期结果**：
- ✅ 显示适当的错误信息
- ✅ 自动重试机制生效（最多2次）
- ✅ 不会导致应用崩溃

#### 步骤 4.2：网络恢复测试
1. 恢复网络连接
2. 观察数据是否自动重新加载

**预期结果**：
- ✅ 网络恢复后自动重新获取数据
- ✅ 界面正常更新

### 5. 刷新功能测试

#### 步骤 5.1：手动刷新
1. 打开薪资数据模态框
2. 点击"刷新"按钮
3. 观察数据重新加载过程

**预期结果**：
- ✅ 显示加载状态
- ✅ 发起新的 API 请求
- ✅ 数据成功更新
- ✅ 显示成功提示信息

### 6. 性能测试

#### 步骤 6.1：多次打开关闭
1. 连续多次打开和关闭薪资数据模态框
2. 观察内存使用情况
3. 检查是否有内存泄漏

**预期结果**：
- ✅ 响应速度保持稳定
- ✅ 内存使用合理，无明显泄漏
- ✅ 缓存正常工作

## 🔍 调试技巧

### 浏览器控制台日志
查找以下日志信息：
```
🔄 [usePayrollDataQuery] 开始获取薪资数据
✅ [usePayrollDataQuery] 数据获取成功
✅ [PayrollDataModal] React Query 数据获取成功
```

### Network 面板检查
- 查看 API 请求的频率和响应时间
- 验证缓存命中时是否减少了网络请求

### React Query DevTools
- 查询状态：`idle` → `loading` → `success` / `error`
- 缓存时间：`dataUpdatedAt` 和 `staleTime`
- 查询键：确保正确的查询键格式

## 📊 测试结果记录

### 测试环境
- 浏览器：
- 操作系统：
- 测试时间：

### 测试结果
| 测试项目 | 状态 | 备注 |
|---------|------|------|
| 基础功能 | ⏳ 待测试 | |
| 缓存机制 | ⏳ 待测试 | |
| DevTools | ⏳ 待测试 | |
| 错误处理 | ⏳ 待测试 | |
| 刷新功能 | ⏳ 待测试 | |
| 性能表现 | ⏳ 待测试 | |

### 发现的问题
1. 
2. 
3. 

### 改进建议
1. 
2. 
3. 

---

**测试完成后，请更新 `react-query-test-results.md` 文件中的验证状态。** 