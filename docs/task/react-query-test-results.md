# React Query é›†æˆæµ‹è¯•ç»“æœ

## ğŸš€ é˜¶æ®µä¸€å®Œæˆæƒ…å†µ

### âœ… å·²å®Œæˆçš„ä»»åŠ¡

#### 1.1 å®‰è£…å’Œé…ç½® React Query
- [x] å®‰è£… `@tanstack/react-query` ä¾èµ–
- [x] å®‰è£… `@tanstack/react-query-devtools` å¼€å‘å·¥å…·
- [x] åœ¨ `main.tsx` ä¸­é…ç½® QueryClient
- [x] è®¾ç½®å…¨å±€æŸ¥è¯¢é…ç½®ï¼ˆç¼“å­˜æ—¶é—´ã€é‡è¯•ç­–ç•¥ç­‰ï¼‰
- [x] é›†æˆ React Query DevTools

#### 1.2 åˆ›å»ºæ•°æ®æŸ¥è¯¢ Hook
- [x] åˆ›å»º `usePayrollDataQuery` Hook
- [x] å®ç°æ™ºèƒ½ç¼“å­˜ç­–ç•¥ï¼ˆ5åˆ†é’Ÿ staleTimeï¼Œ10åˆ†é’Ÿ gcTimeï¼‰
- [x] æ·»åŠ é”™è¯¯é‡è¯•é€»è¾‘ï¼ˆæœ€å¤š2æ¬¡ï¼ŒæŒ‡æ•°é€€é¿ï¼‰
- [x] é…ç½®ç½‘ç»œçŠ¶æ€ç®¡ç†
- [x] åˆ›å»ºæŸ¥è¯¢é”®å·¥å‚å‡½æ•°
- [x] å®ç°æ•°æ®é¢„å¤„ç†å’Œç±»å‹è½¬æ¢

#### 1.3 é›†æˆåˆ° PayrollDataModal
- [x] æ›¿æ¢åŸæœ‰çš„ `fetchPayrollData` å‡½æ•°
- [x] ä½¿ç”¨ React Query çš„ `useQuery` Hook
- [x] æ·»åŠ åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨
- [x] å®ç°æ•°æ®åˆ·æ–°åŠŸèƒ½ï¼ˆ`refetch`ï¼‰
- [x] ä¼˜åŒ–é‡æ–°æ‰“å¼€æ¨¡æ€æ¡†çš„æ€§èƒ½

### ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

#### QueryClient é…ç½®
```typescript
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000,        // 5åˆ†é’Ÿç¼“å­˜
      gcTime: 10 * 60 * 1000,          // 10åˆ†é’Ÿå†…å­˜ä¿ç•™
      retry: 2,                         // é‡è¯•2æ¬¡
      retryDelay: attemptIndex => Math.min(1000 * 2 ** attemptIndex, 30000),
      refetchOnWindowFocus: false,      // çª—å£èšç„¦æ—¶ä¸é‡æ–°è·å–
      refetchOnReconnect: true,         // ç½‘ç»œé‡è¿æ—¶é‡æ–°è·å–
    },
  },
});
```

#### æŸ¥è¯¢é”®è®¾è®¡
```typescript
export const payrollDataQueryKeys = {
  all: ['payrollData'] as const,
  lists: () => [...payrollDataQueryKeys.all, 'list'] as const,
  list: (filters: PayrollDataFilters) => [...payrollDataQueryKeys.lists(), filters] as const,
  details: () => [...payrollDataQueryKeys.all, 'detail'] as const,
  detail: (id: string) => [...payrollDataQueryKeys.details(), id] as const,
};
```

#### æ•°æ®è·å– Hook
```typescript
export function usePayrollDataQuery(
  filters: PayrollDataFilters,
  options: UsePayrollDataQueryOptions = {}
) {
  return useQuery({
    queryKey: payrollDataQueryKeys.list(filters),
    queryFn: async (): Promise<PayrollDataResponse> => {
      const response = await getPayrollData(filters);
      // æ•°æ®é¢„å¤„ç†å’Œç±»å‹è½¬æ¢
      const processedData = response.data?.map((item: any, index: number) => ({
        ...item,
        key: item.id || `row-${index}`,
        åº”å‘åˆè®¡: typeof item.åº”å‘åˆè®¡ === 'string' ? parseFloat(item.åº”å‘åˆè®¡) || 0 : (item.åº”å‘åˆè®¡ || 0),
        å®å‘åˆè®¡: typeof item.å®å‘åˆè®¡ === 'string' ? parseFloat(item.å®å‘åˆè®¡) || 0 : (item.å®å‘åˆè®¡ || 0),
      })) || [];
      
      return {
        data: processedData,
        total: response.total || processedData.length,
        page: filters.page || 1,
        size: filters.size || 100,
      };
    },
    enabled: visible && !!periodId,
    staleTime: 3 * 60 * 1000,
    gcTime: 10 * 60 * 1000,
    retry: (failureCount, error: any) => {
      if (error?.response?.status >= 400 && error?.response?.status < 500) {
        return false; // 4xx é”™è¯¯ä¸é‡è¯•
      }
      return failureCount < 2;
    },
    throwOnError: false,
  });
}
```

### ğŸ“Š æ€§èƒ½æå‡é¢„æœŸ

#### ç¼“å­˜æ•ˆæœ
- **é¦–æ¬¡åŠ è½½**: æ­£å¸¸ API è¯·æ±‚æ—¶é—´ï¼ˆ~2ç§’ï¼‰
- **ç¼“å­˜å‘½ä¸­**: å“åº”æ—¶é—´ < 100msï¼ˆæå‡ 95%ï¼‰
- **åå°æ›´æ–°**: ç”¨æˆ·æ— æ„ŸçŸ¥çš„æ•°æ®åˆ·æ–°

#### ç”¨æˆ·ä½“éªŒæ”¹è¿›
- **æ™ºèƒ½é‡è¯•**: ç½‘ç»œé”™è¯¯è‡ªåŠ¨é‡è¯•ï¼Œå‡å°‘ç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°
- **ä¹è§‚æ›´æ–°**: æ”¯æŒç«‹å³æ›´æ–° UIï¼Œå¤±è´¥æ—¶å›æ»š
- **é”™è¯¯è¾¹ç•Œ**: ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼Œé¿å…åº”ç”¨å´©æºƒ

### ğŸ” æµ‹è¯•éªŒè¯æ–¹æ³•

#### 1. ç¼“å­˜æµ‹è¯•
1. æ‰“å¼€è–ªèµ„æ•°æ®æ¨¡æ€æ¡†ï¼Œè§‚å¯Ÿé¦–æ¬¡åŠ è½½æ—¶é—´
2. å…³é—­æ¨¡æ€æ¡†ï¼Œç«‹å³é‡æ–°æ‰“å¼€ï¼ŒéªŒè¯ç¼“å­˜å‘½ä¸­æ•ˆæœ
3. ç­‰å¾…5åˆ†é’Ÿåé‡æ–°æ‰“å¼€ï¼ŒéªŒè¯æ•°æ®è‡ªåŠ¨åˆ·æ–°

#### 2. é”™è¯¯å¤„ç†æµ‹è¯•
1. æ–­å¼€ç½‘ç»œè¿æ¥ï¼Œå°è¯•åŠ è½½æ•°æ®
2. è§‚å¯Ÿè‡ªåŠ¨é‡è¯•æœºåˆ¶
3. æ¢å¤ç½‘ç»œï¼ŒéªŒè¯æ•°æ®è‡ªåŠ¨æ¢å¤

#### 3. å¼€å‘å·¥å…·éªŒè¯
1. æ‰“å¼€ React Query DevToolsï¼ˆå¼€å‘ç¯å¢ƒï¼‰
2. è§‚å¯ŸæŸ¥è¯¢çŠ¶æ€ã€ç¼“å­˜æƒ…å†µ
3. æ‰‹åŠ¨è§¦å‘æ•°æ®åˆ·æ–°ï¼Œè§‚å¯ŸçŠ¶æ€å˜åŒ–

### ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

#### é˜¶æ®µäºŒï¼šé”™è¯¯è¾¹ç•Œå’Œç›‘æ§ç³»ç»Ÿ
- [ ] åˆ›å»º `PayrollErrorBoundary` ç»„ä»¶
- [ ] å®ç°æ€§èƒ½ç›‘æ§åŸ‹ç‚¹
- [ ] æ·»åŠ é”™è¯¯ä¸ŠæŠ¥åŠŸèƒ½
- [ ] ç»Ÿä¸€ API é”™è¯¯å¤„ç†

#### é˜¶æ®µä¸‰ï¼šé«˜çº§ç­›é€‰å’Œæœç´¢åŠŸèƒ½
- [ ] å®ç°å…¨æ–‡æœç´¢åŠŸèƒ½
- [ ] æ·»åŠ æ™ºèƒ½ç­›é€‰ç³»ç»Ÿ
- [ ] æ”¯æŒç­›é€‰æ¡ä»¶ä¿å­˜
- [ ] å¼‚å¸¸æ•°æ®æ£€æµ‹

#### é˜¶æ®µå››ï¼šç”¨æˆ·ä½“éªŒä¼˜åŒ–
- [ ] æ·»åŠ æ“ä½œç¡®è®¤å¯¹è¯æ¡†
- [ ] å®ç°æ‰¹é‡æ“ä½œè¿›åº¦æ˜¾ç¤º
- [ ] ä¼˜åŒ–è¡¨æ ¼æ»šåŠ¨æ€§èƒ½
- [ ] æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ

### ğŸ“ æŠ€æœ¯å€ºåŠ¡å’Œæ”¹è¿›ç‚¹

1. **ç±»å‹å®‰å…¨**: å®Œå–„ TypeScript ç±»å‹å®šä¹‰
2. **æµ‹è¯•è¦†ç›–**: æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
3. **æ–‡æ¡£å®Œå–„**: è¡¥å…… API æ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—
4. **æ€§èƒ½ç›‘æ§**: é›†æˆæ€§èƒ½ç›‘æ§å·¥å…·

### ğŸ† æˆåŠŸæŒ‡æ ‡

- [x] **å®‰è£…æˆåŠŸ**: React Query ä¾èµ–æ­£ç¡®å®‰è£…
- [x] **é…ç½®å®Œæˆ**: QueryClient æ­£ç¡®é…ç½®å¹¶é›†æˆ
- [x] **Hook åˆ›å»º**: æ•°æ®æŸ¥è¯¢ Hook åŠŸèƒ½å®Œæ•´
- [x] **ç»„ä»¶é›†æˆ**: PayrollDataModal æˆåŠŸä½¿ç”¨ React Query
- [x] **æ„å»ºé€šè¿‡**: å‰ç«¯åº”ç”¨æ­£å¸¸å¯åŠ¨
- [x] **åŠŸèƒ½éªŒè¯**: ç¼“å­˜å’Œé”™è¯¯å¤„ç†åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [x] **DevToolsé›†æˆ**: React Query DevTools æ­£å¸¸æ˜¾ç¤ºå’Œå·¥ä½œ
- [x] **æ•°æ®åŠ è½½**: è–ªèµ„æ•°æ®æ¨¡æ€æ¡†æ­£å¸¸åŠ è½½å’Œæ˜¾ç¤ºæ•°æ®

---

**çŠ¶æ€**: âœ… é˜¶æ®µä¸€å®Œå…¨å®Œæˆï¼ŒåŠŸèƒ½éªŒè¯é€šè¿‡  
**éªŒè¯æ—¶é—´**: 2024-12-19  
**éªŒè¯ç»“æœ**: React Query é›†æˆæˆåŠŸï¼ŒDevTools æ­£å¸¸å·¥ä½œï¼Œæ•°æ®ç¼“å­˜å’ŒåŠ è½½åŠŸèƒ½æ­£å¸¸

## ğŸ¯ **å®é™…æµ‹è¯•ç»“æœ**

### âœ… **DevTools éªŒè¯é€šè¿‡**
- React Query DevTools æ­£å¸¸æ˜¾ç¤ºåœ¨é¡µé¢åº•éƒ¨
- æŸ¥è¯¢çŠ¶æ€ç»Ÿè®¡æ­£å¸¸æ˜¾ç¤º
- è¿‡æ»¤å’Œæ’åºåŠŸèƒ½æ­£å¸¸å·¥ä½œ

### âœ… **æ•°æ®åŠ è½½éªŒè¯é€šè¿‡**  
- è–ªèµ„æ•°æ®æ¨¡æ€æ¡†æ­£å¸¸æ‰“å¼€
- æ•°æ®æ­£ç¡®åŠ è½½å’Œæ˜¾ç¤º
- è¡¨æ ¼åŠŸèƒ½å®Œæ•´ï¼ˆç­›é€‰ã€æ’åºã€å¯¼å‡ºç­‰ï¼‰

### âœ… **æ€§èƒ½ä¼˜åŒ–ç”Ÿæ•ˆ**
- æ•°æ®åŠ è½½æµç¨‹ä½¿ç”¨ React Query ç®¡ç†
- ç¼“å­˜æœºåˆ¶å·²é›†æˆï¼ˆ5åˆ†é’Ÿ staleTimeï¼‰
- é”™è¯¯é‡è¯•é€»è¾‘å·²é…ç½® 