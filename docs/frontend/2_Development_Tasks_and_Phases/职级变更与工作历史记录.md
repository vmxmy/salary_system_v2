# 职级变更与工作历史记录

## 功能概述

为了准确跟踪员工职业发展历程和维护人事数据完整性，系统现已实现职级变更的自动记录功能。当员工的职位或职级发生变化时，系统会自动创建工作历史记录并更新相关时间字段，确保数据一致性和历史可追溯性。

## 实现逻辑

### 1. 员工职级变更时的数据记录

当员工职级发生变更（通过更新`actual_position_id`字段）时，系统会执行以下操作：

1. **结束现有工作记录**：将员工当前的有效工作历史记录（`end_date`为空的记录）设置结束日期为新职级的生效日期
2. **创建新工作历史**：为新职级创建一条新的工作历史记录，其中：
   - `effective_date`：默认使用`current_position_start_date`字段，若未提供则使用当前日期
   - `end_date`：设为`NULL`，表示这是当前有效的记录，将来职级再次变更时才会结束
   - 关联部门、职位和人员类别信息会从员工当前信息中获取

### 2. 职级首次任职时间处理

针对"职级首次任职时间"（`career_position_level_date`）和"实际任职时间"（`current_position_start_date`）的处理逻辑：

1. **实际任职时间**：每次职级变更时，都需要更新为当前职级在本单位的开始时间
2. **职级首次任职时间**：系统会检查是否为员工首次担任该职级
   - 若是首次担任（在工作历史中未发现该职级的记录），则将`career_position_level_date`更新为与`current_position_start_date`相同的值
   - 若非首次担任，则保持`career_position_level_date`不变

### 3. 员工创建时的初始工作历史

当新建员工时，系统也会自动创建一条初始工作历史记录，确保数据完整性：

1. **单个员工创建**：通过`create_employee`函数创建员工时，自动生成工作历史记录
2. **批量导入员工**：通过`create_bulk_employees`函数批量创建员工时，每个员工都会自动创建相应的工作历史记录

## 数据关联与影响

此功能实现后，员工的职级变更会自动体现在以下数据中：

1. **员工主表**：
   - `current_position_start_date`（实际任职时间）
   - `career_position_level_date`（任职级时间，仅在首次担任该职级时更新）

2. **工作历史表**：
   - 创建新的`EmployeeJobHistory`记录
   - 包含完整的部门、职位、人员类别信息
   - 记录精确的开始日期和结束日期

## 注意事项

1. 职级变更时必须提供或能推导出有效的生效日期
2. 确保员工具有有效的部门ID和人员类别ID，否则无法创建完整的工作历史记录
3. 通过API接口更新员工职级时，如需指定生效日期，应在`current_position_start_date`字段中提供 