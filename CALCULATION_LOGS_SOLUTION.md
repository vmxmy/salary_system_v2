# 薪资运行删除问题解决方案

## 问题描述

当尝试删除薪资运行时，遇到以下错误：
```json
{
    "code": 409,
    "message": "Conflict",
    "details": "无法删除该薪资运行，因为它包含关联的计算日志数据。请先删除相关的计算日志记录。"
}
```

## 问题原因

这个错误是由于数据库外键约束导致的。薪资运行（`payroll_runs`）表与计算日志（`calculation_logs`）表之间存在外键关系：

- `payroll.calculation_logs.payroll_run_id` 指向 `payroll.payroll_runs.id`
- 当薪资运行记录有关联的计算日志时，数据库会阻止删除操作

## 什么是计算日志

计算日志（`payroll.calculation_logs`）记录了薪资计算引擎的详细执行过程，包括：

- **组件计算记录**：每个薪资组件（如基本工资、津贴、扣款等）的计算过程
- **计算结果**：每个组件的计算结果金额
- **执行状态**：成功、错误或警告
- **错误信息**：如果计算失败，记录具体的错误原因
- **执行时间**：计算耗时统计

## 解决方案

### 1. 后端API接口

在 `webapp/v2/routers/payroll.py` 中添加了两个新的API接口：

#### 查询计算日志
```
GET /payroll/calculation-logs
```
支持按薪资运行ID、员工ID、组件代码、状态等条件筛选查询。

#### 删除计算日志
```
DELETE /payroll/calculation-logs?payroll_run_id={id}&confirm=true
```
可以删除指定薪资运行的所有计算日志记录。

### 2. 前端管理页面

创建了 `frontend/v2/src/pages/Payroll/pages/CalculationLogsPage.tsx`：

- **查看功能**：可以查看所有计算日志记录，包括员工信息、组件代码、计算结果、状态等
- **筛选功能**：支持按薪资运行ID、员工ID、组件代码、状态进行筛选
- **删除功能**：可以删除指定薪资运行或员工的所有计算日志
- **分页支持**：支持分页浏览大量日志记录

### 3. 路由配置

在薪资模块路由中添加了计算日志管理页面：
```
/finance/payroll/calculation-logs
```

### 4. 用户体验优化

- 在薪资运行页面添加了"计算日志管理"按钮，方便快速跳转
- 优化了删除失败的错误提示，明确指导用户如何处理
- 添加了说明文档，解释计算日志的作用和用途

## 使用步骤

### 查看关联的计算日志

1. 访问 `/finance/payroll/calculation-logs` 页面
2. 在"薪资运行ID"输入框中输入要删除的薪资运行ID
3. 点击"搜索"查看该薪资运行的所有计算日志

### 删除计算日志

1. 在计算日志列表中，找到对应的记录
2. 点击操作列中的删除按钮（红色垃圾桶图标）
3. 确认删除操作

### 删除薪资运行

在清理完计算日志后，就可以正常删除薪资运行了。

## 数据安全说明

- 删除计算日志会永久丢失薪资计算的详细过程记录
- 建议在删除前先导出或备份相关数据
- 删除操作需要相应的权限（`payroll_run:manage`）

## 权限要求

- 查看计算日志：`payroll_run:view`
- 删除计算日志：`payroll_run:manage` 