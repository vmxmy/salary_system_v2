const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/employee-service-D8n0hVPx.js","assets/state-vendor-BIBp6L7x.js","assets/react-vendor-D9vUlElp.js","assets/utils-vendor-CFhz7Dje.js","assets/antd-vendor-DWzn6iQK.js"])))=>i.map(i=>d[i]);
import{c as e,e as t,_ as l,T as a,E as s}from"./hr-management-D97vxp0y.js";import{j as r,m as n,n as o,o as i,T as d,M as c,C as p,p as y,q as m,r as u,t as x,A as h,S as _,u as g,v as f,d as j,w as v,x as b,y as w,z as I,B as S,E as k,F as C,G as z,H as E,h as F,J as N,K as P,L as T,N as $}from"./antd-vendor-DWzn6iQK.js";import{b as B}from"./react-vendor-D9vUlElp.js";import{c as A,b as D}from"./employee-service-D8n0hVPx.js";import{u as L}from"./state-vendor-BIBp6L7x.js";import{u as O}from"./i18n-vendor-DF0Yg0Xi.js";const R=e(((e,t)=>({componentDefinitions:[],loading:!1,error:null,fetchComponentDefinitions:async t=>{e({loading:!0,error:null});try{const l={size:100,is_active:!0,...t},a=await A(l);a.data&&a.data.length>0?e({componentDefinitions:a.data,loading:!1}):e({error:"API返回的组件定义数组为空",loading:!1})}catch(l){e({error:l.message||"Failed to fetch component definitions",loading:!1})}},getDefinitionByCode:e=>t().componentDefinitions.find((t=>t.code===e)),getDefinitionByName:e=>t().componentDefinitions.find((t=>t.code===e))}))),M="payroll_period:view",q="payroll_run:view",G="payroll_entry:view",U="payroll_entry:bulk_import",J="payroll_component:view",W=e=>{const{requiredPermissions:t,children:l,fallback:a=null,showError:s=!1}=e,{t:o}=O(),i=L((e=>e.auth.userPermissions||[]));if(L((e=>e.auth.isLoadingUser)))return t&&t.length>0?null:r.jsx(r.Fragment,{children:l});return!t||0===t.length||t.every((e=>i.includes(e)))?r.jsx(r.Fragment,{children:l}):s?r.jsx(n,{type:"error",message:o("common.permission_denied_action"),banner:!0}):r.jsx(r.Fragment,{children:a})},H="/payroll-periods",K="/payroll-runs",Y="/payroll-entries",V="/config/payroll-component-definitions",X=async e=>{try{(null==e?void 0:e.status_lookup_value_id)&&(e.status_lookup_value_id=Number(e.status_lookup_value_id));return(await D.get(H,{params:e})).data}catch(t){throw t.response||t.request,t}},Q=async e=>{try{return(await D.post(H,e)).data}catch(t){throw t}},Z=async(e,t)=>{try{return(await D.put(`${H}/${e}`,t)).data}catch(l){throw l}},ee=async e=>{try{await D.delete(`${H}/${e}`)}catch(t){throw t}},te=async e=>{try{const t=new AbortController,l=setTimeout((()=>{t.abort()}),3e4),a=await D.get(K,{params:e,signal:t.signal});return clearTimeout(l),a.data}catch(t){if("AbortError"===t.name)throw new Error("API request timeout - please check your network connection");throw t.response||t.request,t}},le=async e=>{try{return(await D.post(K,e)).data}catch(t){throw t}},ae=async(e,t)=>{try{return(await D.get(`${K}/${e}`,{params:t})).data}catch(l){throw l}},se=async(e,t)=>{try{return(await D.put(`${K}/${e}`,t)).data}catch(l){throw l}},re=async e=>{try{await D.delete(`${K}/${e}`)}catch(t){throw t}},ne=async e=>{try{return(await D.get(`${K}/${e}/bank-export`,{responseType:"blob"})).data}catch(t){throw t}},oe=async e=>{try{const t=await D.get(Y,{params:e});if(t.data.data.length>0){t.data.data[0]}return t.data}catch(t){throw t}},ie=async e=>{try{return(await D.get(`${Y}/${e}`)).data}catch(t){throw t}},de=async(e,t)=>{try{D.defaults.headers;t.earnings_details&&Array.isArray(t.earnings_details),t.deductions_details&&Array.isArray(t.deductions_details);return(await D.patch(`${Y}/${e}`,t)).data}catch(l){throw l.response,l}},ce=async e=>{try{return(await D.post(Y,e)).data}catch(t){throw t}},pe=async e=>{try{await D.delete(`${Y}/${e}`)}catch(t){throw t}},ye=async e=>{try{return(await D.get(V,{params:e})).data}catch(t){throw t}},me=async e=>{try{return(await D.post(V,e)).data}catch(t){throw t}},ue=async(e,t)=>{try{return(await D.put(`${V}/${e}`,t)).data}catch(l){throw l.response||l.request,l}},xe=async e=>{try{return await D.delete(`${V}/${e}`),!0}catch(t){throw t}},he=async e=>{try{return(await D.get(`${H}/${e}`)).data}catch(t){throw t}},_e=Object.freeze(Object.defineProperty({__proto__:null,createPayrollComponentDefinition:me,createPayrollEntry:ce,createPayrollPeriod:Q,createPayrollRun:le,deletePayrollComponentDefinition:xe,deletePayrollEntry:pe,deletePayrollPeriod:ee,deletePayrollRun:re,exportPayrollRunBankFile:ne,getPayrollComponentDefinitions:ye,getPayrollEntries:oe,getPayrollEntryById:ie,getPayrollPeriodById:he,getPayrollPeriods:X,getPayrollRunById:ae,getPayrollRuns:te,updatePayrollComponentDefinition:ue,updatePayrollEntryDetails:de,updatePayrollPeriod:Z,updatePayrollRun:se},Symbol.toStringTag,{value:"Module"})),ge=[{id:60,display_name_key:"payroll_run_status.pending_calculation",color:"default",type:"pending"},{id:61,display_name_key:"payroll_run_status.calculated",color:"blue",type:"processing"},{id:62,display_name_key:"payroll_run_status.approved_for_payment",color:"purple",type:"active"},{id:63,display_name_key:"payroll_run_status.paid",color:"success",type:"success"}],fe=e=>{if(null==e)return{key:"run.common.status_na",color:"default",type:"custom"};const t=ge.find((t=>t.id===e));return t?{key:t.display_name_key,color:t.color,type:t.type}:{key:"run.common.unknown_status_param",params:{statusId:e},color:"default",type:"custom"}},je=[{id:301,display_name_key:"payroll_entry_status.pending_calculation",color:"default",type:"pending"},{id:302,display_name_key:"payroll_entry_status.calculated",color:"blue",type:"processing"},{id:303,display_name_key:"payroll_entry_status.pending_confirmation",color:"orange",type:"pending"},{id:304,display_name_key:"payroll_entry_status.confirmed",color:"green",type:"success"},{id:305,display_name_key:"payroll_entry_status.adjusted",color:"purple",type:"custom"},{id:306,display_name_key:"payroll_entry_status.archived",color:"cyan",type:"archived"},{id:307,display_name_key:"payroll_entry_status.error",color:"error",type:"error"},{id:64,display_name_key:"payroll_entry_status.draft",color:"default",type:"draft"}],ve=e=>{if(null==e)return{key:"status.na",color:"default",type:"custom"};let t=e;1===e&&(t=301),2===e&&(t=302),3===e&&(t=304);const l=je.find((e=>e.id===t));return l?{key:l.display_name_key,color:l.color,type:l.type}:{key:"status.unknown_status_param",params:{statusId:e},color:"default",type:"custom"}},be=[{id:137,display_name_key:"payroll_period_status.planned",color:"default",type:"planned"},{id:134,display_name_key:"payroll_period_status.active",color:"green",type:"active"},{id:135,display_name_key:"payroll_period_status.closed",color:"blue",type:"closed"},{id:136,display_name_key:"payroll_period_status.archived",color:"gray",type:"archived"}],we="employee_cache_v1",Ie=864e5,Se={getCache(){try{const e=localStorage.getItem(we);return e?JSON.parse(e):{}}catch(e){return{}}},saveCache(e){try{localStorage.setItem(we,JSON.stringify(e))}catch(t){}},getEmployee(e){if(!e)return null;const t=String(e),l=this.getCache()[t];return l&&Date.now()-l.timestamp<Ie?l.data:null},getEmployees(e){if(!e||0===e.length)return{};const t={},l=this.getCache(),a=Date.now();return e.forEach((e=>{const s=String(e),r=l[s];r&&a-r.timestamp<Ie&&(t[s]=r.data)})),t},saveEmployee(e){if(!e||!e.id)return;const t=String(e.id),l=this.getCache();l[t]={data:e,timestamp:Date.now()},this.saveCache(l)},saveEmployees(e){if(!e)return;const t=this.getCache(),l=Date.now();Array.isArray(e)?e.forEach((e=>{e&&e.id&&(t[String(e.id)]={data:e,timestamp:l})})):Object.entries(e).forEach((([e,a])=>{a&&(t[e]={data:a,timestamp:l})})),this.saveCache(t)},removeEmployee(e){if(!e)return;const t=String(e),l=this.getCache();l[t]&&(delete l[t],this.saveCache(l))},clearCache(){localStorage.removeItem(we)},getEmployeeFullName(e){if(!e)return"";return`${e.last_name||""}${e.first_name||""}`.trim()},getEmployeeNameById(e){if(!e)return"";const t=this.getEmployee(e);return this.getEmployeeFullName(t)}},ke=({employeeId:e,employeeName:l,showId:a=!0,showLoading:s=!0,className:n="",style:d})=>{const{t:c}=O(["common","employee"]),[p,y]=B.useState(!1),[m,u]=B.useState(l||null);B.useEffect((()=>{if(l)return void u(l);if(!e)return void u(null);const a=String(e),r=Se.getEmployeeNameById(a);if(r)return void u(r);(async()=>{if(s){y(!0);try{const e=await t.getEmployeeById(a);e&&(Se.saveEmployee(e),u(Se.getEmployeeFullName(e)))}catch(e){}finally{y(!1)}}})()}),[e,l,s]);return r.jsx("div",{className:`employee-name-component ${n}`,style:d,children:p?r.jsx(o,{size:"small"}):m?r.jsxs("span",{className:"employee-name",children:[m,a&&e&&r.jsxs("span",{className:"employee-id",children:["(",e,")"]})]}):e?r.jsx("span",{children:c("employee:employee_id_format",{id:e})}):r.jsx(i,{children:c("common:unavailable")})})},Ce={getPayrollModalData:async e=>(await D.get(`/reports/payroll-modal/data/${e}`)).data},{Title:ze,Text:Ee}=d,Fe=({entryId:e,visible:l,onClose:a})=>{var s,i,d,h,_,g,f,j,v,b,w,I,S,k,C,z,E,F,N,P,T,$,A,D,L,M,q,G,U,J,W,H,K,Y,V;const{t:X}=O(["common","payroll"]),[Q,Z]=B.useState(null),[ee,te]=B.useState(null),[le,ae]=B.useState(!1),[se,re]=B.useState(null),[ne,oe]=B.useState(null),[de,ce]=B.useState(!1),[pe,ye]=B.useState(!1),me=R();B.useEffect((()=>{if(l){if(ye(!1),me.componentDefinitions.length>0)return void ye(!0);(async()=>{try{await me.fetchComponentDefinitions(),ye(!0)}catch(e){ye(!0)}})()}}),[l]);const ue=async e=>{ae(!0),re(null);try{const l=await Ce.getPayrollModalData(Number(e));te(l);const a=await ie(Number(e));Z(a.data),!a.data.employee_name&&a.data.employee_id&&(async e=>{if(e){ce(!0);try{const l=await t.getEmployeeById(String(e));if(l){const e={firstName:l.first_name,lastName:l.last_name,displayName:`${l.last_name||""}${l.first_name||""}`};oe(e)}else oe(null)}catch(l){oe(null)}finally{ce(!1)}}})(a.data.employee_id)}catch(l){re(l.message||X("payroll:entry_detail_modal.error_fetch_details")),Z(null),te(null)}ae(!1)};B.useEffect((()=>{l&&e&&pe&&ue(e)}),[l,e,pe]),B.useEffect((()=>{l||(Z(null),te(null),re(null),oe(null))}),[l]);return X("payroll:entry_detail_modal.earnings_table.component_name"),X("payroll:entry_detail_modal.earnings_table.amount"),X("payroll:entry_detail_modal.earnings_table.description"),X("payroll:entry_detail_modal.deductions_table.component_name"),X("payroll:entry_detail_modal.deductions_table.amount"),X("payroll:entry_detail_modal.deductions_table.description"),r.jsxs(c,{title:X("payroll:entry_detail_modal.title"),open:l,onCancel:a,footer:null,width:1e3,destroyOnHidden:!0,children:[(le||!pe)&&r.jsx(o,{tip:X(pe?"payroll:entry_detail_modal.loading":"payroll:auto___e6ada3"),style:{display:"block",marginTop:"50px"},children:r.jsx("div",{style:{padding:50}})}),se&&r.jsx(n,{message:X("payroll:entry_detail_modal.error_prefix")+se,type:"error",showIcon:!0,style:{marginBottom:"20px"}}),!le&&!se&&ee&&r.jsxs("div",{children:[r.jsx(p,{title:"基础信息",style:{marginBottom:16},children:r.jsxs(y,{bordered:!0,column:{xxl:2,xl:2,lg:2,md:1,sm:1,xs:1},children:[r.jsx(y.Item,{label:"员工编号",children:ee.基础信息.员工编号||"-"}),r.jsx(y.Item,{label:"员工姓名",children:ee.基础信息.员工姓名||"-"}),r.jsx(y.Item,{label:"部门名称",children:ee.基础信息.部门名称||"-"}),r.jsx(y.Item,{label:"职位名称",children:ee.基础信息.职位名称||"-"}),r.jsx(y.Item,{label:"人员类别",children:ee.基础信息.人员类别||"-"}),r.jsx(y.Item,{label:"编制",children:ee.基础信息.编制||"-"}),r.jsx(y.Item,{label:"薪资期间",children:ee.基础信息.薪资期间名称||"-"}),r.jsx(y.Item,{label:"期间开始日期",children:ee.基础信息.期间开始日期||"-"}),r.jsx(y.Item,{label:"期间结束日期",children:ee.基础信息.期间结束日期||"-"})]})}),ee.员工详细信息&&r.jsx(p,{title:"员工详细信息",style:{marginBottom:16},children:r.jsx(m,{defaultActiveKey:"contact",size:"small",items:[{key:"contact",label:"联系信息",children:r.jsxs(y,{bordered:!0,column:2,size:"small",children:[r.jsx(y.Item,{label:"手机号码",children:(null==(s=ee.员工详细信息.联系信息)?void 0:s.电话)||"-"}),r.jsx(y.Item,{label:"电子邮箱",children:(null==(i=ee.员工详细信息.联系信息)?void 0:i.邮箱)||"-"}),r.jsx(y.Item,{label:"家庭地址",children:(null==(d=ee.员工详细信息.联系信息)?void 0:d.家庭住址)||"-"}),r.jsx(y.Item,{label:"紧急联系人",children:(null==(h=ee.员工详细信息.联系信息)?void 0:h.紧急联系人)||"-"}),r.jsx(y.Item,{label:"紧急联系人电话",children:(null==(_=ee.员工详细信息.联系信息)?void 0:_.紧急联系电话)||"-"})]})},{key:"personal",label:"个人信息",children:r.jsxs(y,{bordered:!0,column:2,size:"small",children:[r.jsx(y.Item,{label:"身份证号",children:(null==(g=ee.员工详细信息.个人信息)?void 0:g.身份证号)||"-"}),r.jsx(y.Item,{label:"性别",children:(null==(f=ee.员工详细信息.个人信息)?void 0:f.性别)||"-"}),r.jsx(y.Item,{label:"出生日期",children:(null==(j=ee.员工详细信息.个人信息)?void 0:j.出生日期)||"-"}),r.jsx(y.Item,{label:"民族",children:(null==(v=ee.员工详细信息.个人信息)?void 0:v.民族)||"-"}),r.jsx(y.Item,{label:"政治面貌",children:(null==(b=ee.员工详细信息.个人信息)?void 0:b.政治面貌)||"-"}),r.jsx(y.Item,{label:"婚姻状况",children:(null==(w=ee.员工详细信息.个人信息)?void 0:w.婚姻状况)||"-"}),r.jsx(y.Item,{label:"学历",children:(null==(I=ee.员工详细信息.个人信息)?void 0:I.学历)||"-"}),r.jsx(y.Item,{label:"专业",children:(null==(S=ee.员工详细信息.个人信息)?void 0:S.学历)||"-"})]})},{key:"work",label:"工作信息",children:r.jsxs(y,{bordered:!0,column:2,size:"small",children:[r.jsx(y.Item,{label:"入职日期",children:(null==(k=ee.员工详细信息.工作信息)?void 0:k.入职日期)||"-"}),r.jsx(y.Item,{label:"工作状态",children:(null==(C=ee.员工详细信息.工作信息)?void 0:C.员工状态)||"-"}),r.jsx(y.Item,{label:"合同类型",children:(null==(z=ee.员工详细信息.工作信息)?void 0:z.合同类型)||"-"}),r.jsx(y.Item,{label:"合同开始日期",children:(null==(E=ee.员工详细信息.工作信息)?void 0:E.合同开始日期)||"-"}),r.jsx(y.Item,{label:"合同结束日期",children:(null==(F=ee.员工详细信息.工作信息)?void 0:F.合同结束日期)||"-"}),r.jsx(y.Item,{label:"试用期结束日期",children:(null==(N=ee.员工详细信息.工作信息)?void 0:N.试用期结束日期)||"-"})]})},{key:"insurance",label:"社保公积金",children:r.jsxs(y,{bordered:!0,column:2,size:"small",children:[r.jsx(y.Item,{label:"社保账号",children:(null==(P=ee.员工详细信息.社保公积金信息)?void 0:P.社保账号)||"-"}),r.jsx(y.Item,{label:"公积金账号",children:(null==(T=ee.员工详细信息.社保公积金信息)?void 0:T.公积金账号)||"-"}),r.jsx(y.Item,{label:"社保缴费基数",children:(null==($=ee.员工详细信息.社保公积金信息)?void 0:$.社保缴费基数)?`¥${parseFloat(ee.员工详细信息.社保公积金信息.社保缴费基数).toFixed(2)}`:"-"}),r.jsx(y.Item,{label:"公积金缴费基数",children:(null==(A=ee.员工详细信息.社保公积金信息)?void 0:A.公积金缴费基数)?`¥${parseFloat(ee.员工详细信息.社保公积金信息.公积金缴费基数).toFixed(2)}`:"-"})]})},{key:"bank",label:"银行账号",children:r.jsxs(y,{bordered:!0,column:2,size:"small",children:[r.jsx(y.Item,{label:"银行名称",children:(null==(D=ee.员工详细信息.银行账号信息)?void 0:D.银行名称)||"-"}),r.jsx(y.Item,{label:"银行账号",children:(null==(L=ee.员工详细信息.银行账号信息)?void 0:L.银行账号)||"-"}),r.jsx(y.Item,{label:"开户行",children:(null==(M=ee.员工详细信息.银行账号信息)?void 0:M.开户行)||"-"})]})}]})}),r.jsx(p,{title:"薪资汇总",style:{marginBottom:16},children:r.jsxs(u,{gutter:24,children:[r.jsx(x,{span:8,children:r.jsxs("div",{style:{textAlign:"center",padding:"20px",backgroundColor:"#f6ffed",borderRadius:"6px"},children:[r.jsx(Ee,{type:"secondary",children:"应发合计"}),r.jsxs("div",{style:{fontSize:"24px",fontWeight:"bold",color:"#52c41a",marginTop:"8px"},children:["¥",parseFloat(ee.汇总信息.应发合计).toFixed(2)]})]})}),r.jsx(x,{span:8,children:r.jsxs("div",{style:{textAlign:"center",padding:"20px",backgroundColor:"#fff2e8",borderRadius:"6px"},children:[r.jsx(Ee,{type:"secondary",children:"扣除合计"}),r.jsxs("div",{style:{fontSize:"24px",fontWeight:"bold",color:"#fa8c16",marginTop:"8px"},children:["¥",parseFloat(ee.汇总信息.扣除合计).toFixed(2)]})]})}),r.jsx(x,{span:8,children:r.jsxs("div",{style:{textAlign:"center",padding:"20px",backgroundColor:"#e6f7ff",borderRadius:"6px"},children:[r.jsx(Ee,{type:"secondary",children:"实发合计"}),r.jsxs("div",{style:{fontSize:"24px",fontWeight:"bold",color:"#1890ff",marginTop:"8px"},children:["¥",parseFloat(ee.汇总信息.实发合计).toFixed(2)]})]})})]})}),r.jsxs(p,{title:"应发明细",style:{marginBottom:16},children:[r.jsxs("div",{style:{marginBottom:16},children:[r.jsx(ze,{level:5,children:"标准应发项目"}),r.jsx(y,{bordered:!0,column:2,size:"small",children:Object.entries(ee.应发明细||{}).filter((([e])=>"其他应发项目"!==e)).map((([e,t])=>t&&parseFloat(t)>0&&r.jsxs(y.Item,{label:e,children:["¥",parseFloat(t).toFixed(2)]},e)))})]}),Object.keys((null==(q=ee.应发明细)?void 0:q.其他应发项目)||{}).length>0&&r.jsxs("div",{children:[r.jsx(ze,{level:5,children:"其他应发项目"}),r.jsx(y,{bordered:!0,column:2,size:"small",children:Object.entries((null==(G=ee.应发明细)?void 0:G.其他应发项目)||{}).map((([e,t])=>parseFloat(t)>0&&r.jsxs(y.Item,{label:e,children:["¥",parseFloat(t).toFixed(2)]},e)))})]})]}),r.jsxs(p,{title:"扣除明细",style:{marginBottom:16},children:[r.jsxs("div",{style:{marginBottom:16},children:[r.jsx(ze,{level:5,children:"个人扣缴项目"}),r.jsxs(y,{bordered:!0,column:2,size:"small",children:[Object.entries((null==(U=ee.扣除明细)?void 0:U.个人扣缴项目)||{}).filter((([e])=>"其他个人扣缴"!==e)).map((([e,t])=>t&&parseFloat(t)>0&&r.jsxs(y.Item,{label:e,children:["¥",parseFloat(t).toFixed(2)]},e))),Object.entries((null==(W=null==(J=ee.扣除明细)?void 0:J.个人扣缴项目)?void 0:W.其他个人扣缴)||{}).map((([e,t])=>parseFloat(t)>0&&r.jsxs(y.Item,{label:e,children:["¥",parseFloat(t).toFixed(2)]},e)))]})]}),r.jsxs("div",{children:[r.jsx(ze,{level:5,children:"单位扣缴项目"}),r.jsxs(y,{bordered:!0,column:2,size:"small",children:[Object.entries((null==(H=ee.扣除明细)?void 0:H.单位扣缴项目)||{}).filter((([e])=>"其他单位扣缴"!==e)).map((([e,t])=>t&&parseFloat(t)>0&&r.jsxs(y.Item,{label:e,children:["¥",parseFloat(t).toFixed(2)]},e))),Object.entries((null==(Y=null==(K=ee.扣除明细)?void 0:K.单位扣缴项目)?void 0:Y.其他单位扣缴)||{}).map((([e,t])=>parseFloat(t)>0&&r.jsxs(y.Item,{label:e,children:["¥",parseFloat(t).toFixed(2)]},e)))]})]})]}),r.jsx(p,{title:"计算参数",style:{marginBottom:16},children:r.jsxs(y,{bordered:!0,column:2,size:"small",children:[Object.entries(ee.计算参数||{}).filter((([e])=>"其他计算参数"!==e)).map((([e,t])=>t&&parseFloat(t)>0&&r.jsx(y.Item,{label:e,children:e.includes("费率")?`${(100*parseFloat(t)).toFixed(2)}%`:`¥${parseFloat(t).toFixed(2)}`},e))),Object.entries((null==(V=ee.计算参数)?void 0:V.其他计算参数)||{}).map((([e,t])=>parseFloat(t)>0&&r.jsx(y.Item,{label:e,children:e.includes("费率")?`${(100*parseFloat(t)).toFixed(2)}%`:`¥${parseFloat(t).toFixed(2)}`},e)))]})})]}),!le&&!se&&!ee&&r.jsx(n,{message:"薪资数据未找到",type:"warning",showIcon:!0})]})},Ne=({payrollRunId:e})=>{const{t:c}=O(["payroll_runs","common"]),[p,y]=B.useState([]),[m,u]=B.useState(null),[x,g]=B.useState(!0),[f,j]=B.useState(null),[v,b]=B.useState({}),[w,I]=B.useState(!1),[S,k]=B.useState(!1),[C,z]=B.useState(null),{message:E}=h.useApp(),F=B.useCallback((async(t=1,a=100)=>{g(!0),j(null);try{const r=await oe({payroll_run_id:e,page:t,size:a,include_employee_details:!0,sort_by:"employee_id",sort_order:"asc"});if(r.data&&r.data.length>0){const e=r.data.filter((e=>e.employee_id&&!e.employee_name)).map((e=>String(e.employee_id)));if(e.length>0){const t=Se.getEmployees(e),a=e.filter((e=>!t[e]));if(a.length>0)try{I(!0);const{employeeService:e}=await l((async()=>{const{employeeService:e}=await import("./employee-service-D8n0hVPx.js").then((e=>e.M));return{employeeService:e}}),__vite__mapDeps([0,1,2,3,4])),t=await e.getEmployeesByIds(a);Object.keys(t).length>0&&Se.saveEmployees(t)}catch(s){}finally{I(!1)}}y(r.data),u(r.meta||{total:0,page:1,size:a,totalPages:0})}else y([]),u(r.meta||{total:0,page:1,size:a,totalPages:0})}catch(r){j(c("payroll:payroll_entries_table.error_fetch"))}finally{g(!1)}}),[e,c]),N=B.useCallback((async e=>{if(!e.length)return;const a=e.filter((e=>!v[e]));if(a.length){I(!0);try{const e={...v},{employeeService:s}=await l((async()=>{const{employeeService:e}=await import("./employee-service-D8n0hVPx.js").then((e=>e.M));return{employeeService:e}}),__vite__mapDeps([0,1,2,3,4])),r=a.map((async l=>{try{const a=await t.getEmployeeById(String(l));if(a)return e[l]={firstName:a.first_name,lastName:a.last_name,displayName:`${a.last_name||""}${a.first_name||""}`},!0}catch(a){}return!1}));await Promise.all(r),b(e),y((t=>t.map((t=>{var l;return(null==(l=e[t.employee_id])?void 0:l.displayName)?{...t,employee_name:e[t.employee_id].displayName}:t}))))}catch(s){}finally{I(!1)}}}),[v]);B.useEffect((()=>{if(p.length>0){const e=p.filter((e=>!e.employee_name)).map((e=>e.employee_id));e.length>0&&N(e)}}),[p,N]),B.useEffect((()=>{F()}),[F]);const P=[{title:c("payroll:payroll_entries_table.column.employeeId"),dataIndex:"employee_id",key:"employee_id",width:90,valueType:"digit",sorter:(e,t)=>e.employee_id-t.employee_id,search:!1},{title:c("payroll:payroll_entries_table.column.employeeName"),dataIndex:"employee_name",key:"employee_name",width:130,valueType:"text",sorter:(e,t)=>(e.employee_name||"").localeCompare(t.employee_name||""),render:(e,t,l)=>r.jsx(ke,{employeeId:t.employee_id,employeeName:t.employee_name,showId:!1,showLoading:!0,className:"payroll-entry-employee-name"})},{title:c("payroll:payroll_entries_table.column.grossPay"),dataIndex:"gross_pay",key:"gross_pay",width:110,align:"right",valueType:"money",sorter:(e,t)=>(Number(e.gross_pay)||0)-(Number(t.gross_pay)||0),render:(e,t,l)=>(Number(t.gross_pay)||0).toFixed(2),search:!1},{title:c("payroll:payroll_entries_table.column.deductions"),dataIndex:"total_deductions",key:"total_deductions",width:110,align:"right",valueType:"money",sorter:(e,t)=>(Number(e.total_deductions)||0)-(Number(t.total_deductions)||0),render:(e,t,l)=>(Number(t.total_deductions)||0).toFixed(2),search:!1},{title:c("payroll:payroll_entries_table.column.netPay"),dataIndex:"net_pay",key:"net_pay",width:110,align:"right",valueType:"money",render:(e,t,l)=>r.jsx(d.Text,{strong:!0,children:(Number(t.net_pay)||0).toFixed(2)}),sorter:(e,t)=>(Number(e.net_pay)||0)-(Number(t.net_pay)||0),search:!1},{title:c("payroll:payroll_entries_table.column.status"),dataIndex:"status_lookup_value_id",key:"status",width:100,align:"center",valueType:"select",valueEnum:{1:{text:c("payroll:status.draft"),status:"default"},2:{text:c("payroll:status.finalized"),status:"processing"},3:{text:c("payroll:status.paid"),status:"success"}},render:(e,t,l)=>{const a=ve(t.status_lookup_value_id);return r.jsx(i,{color:a.color,children:c(`payroll:${a.key}`,a.params)})},search:!1},{title:c("common:label.actions"),key:"actions",width:100,align:"center",valueType:"option",fixed:"right",render:(e,t,l)=>r.jsxs(_,{size:"small",children:[r.jsx(W,{requiredPermissions:[G],children:r.jsx(a,{actionType:"view",onClick:()=>(z(t.id),void k(!0)),tooltipTitle:c("payroll:payroll_entries_table.tooltip_view_details")})}),r.jsx(W,{requiredPermissions:["payroll_entry:edit_details"],children:r.jsx(a,{actionType:"edit",onClick:()=>{E.info(c("payroll:payroll_entries_table.message.edit_entry_todo"))},tooltipTitle:c("payroll:payroll_entries_table.tooltip_edit_entry")})})]})}];return x&&!p.length?r.jsx(o,{tip:c("payroll:payroll_entries_table.spin_loading_entries"),style:{display:"block",marginTop:"20px"},children:r.jsx("div",{style:{padding:50}})}):f?r.jsx(n,{message:`$t('payroll:payroll_entries_table.alert_error_prefix')${f}`,type:"error",showIcon:!0,style:{margin:"10px 0"}}):r.jsx("div",{children:x&&0===p.length?r.jsx("div",{style:{display:"flex",justifyContent:"center",padding:"50px 0"},children:r.jsx(o,{size:"large"})}):f?r.jsx(n,{message:c("common:error.title"),description:f,type:"error",showIcon:!0,style:{marginBottom:16}}):r.jsxs(r.Fragment,{children:[r.jsx("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:r.jsxs(d.Title,{level:5,style:{margin:0},children:["t('payroll:payroll_entries_table.title')",m&&r.jsxs("span",{style:{fontSize:"14px",fontWeight:"normal",marginLeft:8},children:["(",c("payroll:payroll_entries_table.total_entries",{count:m.total}),")"]})]})}),w&&r.jsx(n,{message:c("payroll:payroll_entries_table.loading_employee_names"),type:"info",showIcon:!0,style:{marginBottom:16}}),r.jsx(s,{columns:P,dataSource:p,rowKey:"id",loading:x,pagination:!!m&&{current:m.page,pageSize:m.size,total:m.total,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"],showTotal:e=>c("common:pagination.total_records",{count:e}),onChange:(e,t)=>F(e,t)},scroll:{x:"max-content"},size:"middle",enableAdvancedFeatures:!0,showToolbar:!0,search:!1}),S&&C&&r.jsx(Fe,{entryId:String(C),visible:S,onClose:()=>{k(!1),z(null)}})]})})},{Text:Pe}=d,{Option:Te}=g,$e=({periods:e,selectedPeriodId:t,onChange:l,loading:a=!1,placeholder:s="请选择薪资周期",style:n,showRecordCount:o=!0,showDateRange:d=!0,size:c="middle"})=>r.jsx(g,{value:t,onChange:l,placeholder:s,style:{width:"100%",...n},size:c,loading:a,showSearch:!0,filterOption:(e,t)=>{var l;return((null==(l=null==t?void 0:t.children)?void 0:l.toString().toLowerCase())||"").includes(e.toLowerCase())},optionLabelProp:"label",children:e.map((e=>{const t=e.employee_count||0,l=t>0;return r.jsx(Te,{value:e.id,label:e.name,children:r.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"4px 0"},children:[r.jsxs("div",{style:{flex:1},children:[r.jsxs("div",{style:{display:"flex",alignItems:"center",marginBottom:"2px"},children:[r.jsx(f,{style:{marginRight:"6px",color:"#1890ff",fontSize:"14px"}}),r.jsx(Pe,{strong:!0,style:{fontSize:"14px"},children:e.name})]}),d&&r.jsx("div",{style:{marginLeft:"20px",fontSize:"12px",color:"#666"},children:(a=e.start_date,s=e.end_date,`${new Date(a).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit"})} ~ ${new Date(s).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit"})}`)})]}),r.jsx("div",{style:{display:"flex",alignItems:"center",gap:"6px",marginLeft:"12px"},children:o&&r.jsx(j,{title:`该周期包含 ${t} 条薪资记录`,children:r.jsxs(i,{color:l?"green":"default",style:{margin:0,fontSize:"11px",display:"flex",alignItems:"center",gap:"2px"},children:[r.jsx(v,{style:{fontSize:"10px"}}),t]})})})]})},e.id);var a,s}))});var Be=(e=>(e.NONE="none",e.SMART_MERGE="smart_merge",e.ALL="all",e.EXISTING_ONLY="existing_only",e.INCREMENTAL="incremental",e.FULL_MONTH="full_month",e.SOCIAL_INSURANCE_ONLY="social_insurance_only",e.TAX_ONLY="tax_only",e.ADJUSTMENTS_ONLY="adjustments_only",e.FULL="full",e.PARTIAL="partial",e))(Be||{});const{Title:Ae,Text:De}=d,{Step:Le}=z;var Oe=(e=>(e.IDLE="idle",e.PREPARING="preparing",e.CALCULATING="calculating",e.COMPLETED="completed",e.FAILED="failed",e))(Oe||{});const Re=({visible:e,progress:t,result:l,onClose:a,onRetry:s})=>{const[o,d]=B.useState("");B.useEffect((()=>{const e=setInterval((()=>{d((new Date).toLocaleTimeString())}),1e3);return()=>clearInterval(e)}),[]);const y=()=>t?"completed"===t.status?100:0===t.total?0:Math.round(t.processed/t.total*100):0,m=e=>{switch(e){case"preparing":return"#1890ff";case"calculating":case"completed":return"#52c41a";case"failed":return"#f5222d";default:return"#8c8c8c"}},h=()=>{if(!t)return[];const e=[{title:"准备数据",description:"加载员工信息和配置"},{title:"基础薪资计算",description:"计算应发合计和基础扣除"},{title:"五险一金计算",description:"计算社保和公积金"},{title:"汇总统计",description:"生成最终报告"}],l=e.findIndex((e=>e.title===t.stage));return e.map(((e,t)=>({...e,status:t<l?"finish":t===l?"process":"wait"})))};return r.jsxs(c,{open:e,onCancel:a,centered:!0,width:720,style:{top:20},maskClosable:!1,keyboard:!1,footer:"completed"===(null==t?void 0:t.status)?r.jsxs(_,{children:[s&&r.jsx(S,{onClick:s,children:"重新计算"}),r.jsx(S,{type:"primary",onClick:a,children:"确定"})]}):"failed"===(null==t?void 0:t.status)?r.jsxs(_,{children:[s&&r.jsx(S,{type:"primary",onClick:s,children:"重试"}),r.jsx(S,{onClick:a,children:"取消"})]}):null,title:r.jsxs(_,{children:[r.jsx(I,{style:{color:m((null==t?void 0:t.status)||"idle")}}),r.jsx("span",{children:"集成计算引擎运行状态"}),r.jsxs(i,{color:m((null==t?void 0:t.status)||"idle"),children:["preparing"===(null==t?void 0:t.status)&&"准备中","calculating"===(null==t?void 0:t.status)&&"计算中","completed"===(null==t?void 0:t.status)&&"已完成","failed"===(null==t?void 0:t.status)&&"失败","idle"===(null==t?void 0:t.status)&&"待机"]})]}),children:[!t||"calculating"!==t.status&&"preparing"!==t.status?null:r.jsxs("div",{style:{textAlign:"center",padding:"20px 0"},children:[r.jsx("div",{style:{marginBottom:"24px"},children:r.jsx(k,{type:"circle",percent:y(),width:120,strokeColor:{"0%":"#108ee9","100%":"#87d068"},format:()=>r.jsxs("div",{children:[r.jsxs("div",{style:{fontSize:"18px",fontWeight:"bold"},children:[y(),"%"]}),r.jsxs("div",{style:{fontSize:"12px",color:"#666"},children:[t.processed,"/",t.total]})]})})}),t.current_employee&&r.jsx(p,{size:"small",style:{marginBottom:"16px",background:"#f6ffed",border:"1px solid #b7eb8f"},children:r.jsxs(_,{direction:"vertical",size:"small",style:{width:"100%"},children:[r.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center"},children:[r.jsx(C,{style:{color:"#52c41a",marginRight:"8px"}}),r.jsxs(De,{strong:!0,style:{fontSize:"14px"},children:["正在处理：",t.current_employee.name]})]}),r.jsxs("div",{style:{fontSize:"12px",color:"#666"},children:[t.current_employee.department," - ",t.current_employee.position]})]})}),r.jsxs("div",{style:{marginBottom:"16px"},children:[r.jsxs(De,{type:"secondary",style:{fontSize:"12px",marginBottom:"8px",display:"block"},children:["📋 当前阶段：",t.stage]}),r.jsx(z,{current:h().findIndex((e=>"process"===e.status)),size:"small",direction:"horizontal",items:h().map((e=>({title:e.title,description:e.description})))})]}),t.estimated_remaining_time&&r.jsx(n,{message:`预计剩余时间：${Math.ceil(t.estimated_remaining_time/60)} 分钟`,type:"info",showIcon:!0,style:{marginBottom:"16px"}}),r.jsxs(u,{gutter:16,style:{marginTop:"16px"},children:[r.jsx(x,{span:8,children:r.jsx(E,{title:"已处理",value:t.processed,prefix:r.jsx(F,{style:{color:"#52c41a"}}),valueStyle:{color:"#52c41a"}})}),r.jsx(x,{span:8,children:r.jsx(E,{title:"总计",value:t.total,prefix:r.jsx(N,{style:{color:"#1890ff"}})})}),r.jsx(x,{span:8,children:r.jsx(E,{title:"剩余",value:t.total-t.processed,prefix:r.jsx(w,{style:{color:"#fa8c16"}}),valueStyle:{color:"#fa8c16"}})})]})]}),(()=>{if(!l||!t||"completed"!==t.status)return null;const e=l.error_count>0;return r.jsxs("div",{style:{textAlign:"center",padding:"20px 0"},children:[r.jsxs("div",{style:{marginBottom:"24px"},children:[r.jsx(F,{style:{fontSize:"48px",color:"#52c41a",marginBottom:"16px"}}),r.jsx(Ae,{level:4,style:{color:"#52c41a",margin:0},children:"🎉 计算完成！"}),r.jsxs(De,{type:"secondary",children:["耗时 ",l.duration," 秒，共处理 ",l.total_processed," 名员工"]})]}),r.jsxs(u,{gutter:16,style:{marginBottom:"24px"},children:[r.jsx(x,{span:8,children:r.jsx(E,{title:"成功处理",value:l.success_count,prefix:r.jsx(P,{style:{color:"#52c41a"}}),valueStyle:{color:"#52c41a"},suffix:"人"})}),r.jsx(x,{span:8,children:r.jsx(E,{title:"处理失败",value:l.error_count,prefix:r.jsx(b,{style:{color:l.error_count>0?"#f5222d":"#8c8c8c"}}),valueStyle:{color:l.error_count>0?"#f5222d":"#8c8c8c"},suffix:"人"})}),r.jsx(x,{span:8,children:r.jsx(E,{title:"成功率",value:(l.success_count/l.total_processed*100).toFixed(1),prefix:r.jsx(T,{style:{color:"#1890ff"}}),valueStyle:{color:"#1890ff"},suffix:"%"})})]}),r.jsx($,{}),r.jsxs("div",{style:{marginBottom:"16px"},children:[r.jsx(De,{strong:!0,style:{fontSize:"14px",marginBottom:"12px",display:"block"},children:"💰 薪资汇总结果"}),r.jsxs(u,{gutter:16,children:[r.jsx(x,{span:6,children:r.jsx(E,{title:"应发合计",value:l.payroll_totals.total_gross_pay,precision:2,valueStyle:{color:"#52c41a",fontSize:"14px"},suffix:"元"})}),r.jsx(x,{span:6,children:r.jsx(E,{title:"扣发合计",value:l.payroll_totals.total_deductions,precision:2,valueStyle:{color:"#f5222d",fontSize:"14px"},suffix:"元"})}),r.jsx(x,{span:6,children:r.jsx(E,{title:"实发合计",value:l.payroll_totals.total_net_pay,precision:2,valueStyle:{color:"#1890ff",fontSize:"14px"},suffix:"元"})}),r.jsx(x,{span:6,children:r.jsx(E,{title:"单位成本",value:l.payroll_totals.total_employer_cost,precision:2,valueStyle:{color:"#722ed1",fontSize:"14px"},suffix:"元"})})]})]}),e&&l.errors&&r.jsx(n,{type:"warning",message:`发现 ${l.error_count} 个处理错误`,description:r.jsxs("div",{style:{marginTop:"8px",textAlign:"left"},children:[l.errors.slice(0,3).map(((e,t)=>r.jsxs("div",{style:{marginBottom:"4px"},children:[r.jsxs(De,{code:!0,children:[e.employee_name,"(ID:",e.employee_id,")"]}),": ",e.error_message]},t))),l.errors.length>3&&r.jsxs(De,{type:"secondary",children:["... 还有 ",l.errors.length-3," 个错误"]})]}),showIcon:!0,style:{marginTop:"16px"}})]})})(),"failed"===(null==t?void 0:t.status)&&r.jsxs("div",{style:{textAlign:"center",padding:"40px 0"},children:[r.jsx(b,{style:{fontSize:"48px",color:"#f5222d",marginBottom:"16px"}}),r.jsx(Ae,{level:4,style:{color:"#f5222d"},children:"计算失败"}),r.jsx(De,{type:"secondary",children:"计算过程中发生错误，请检查数据后重试"})]}),!t&&r.jsxs("div",{style:{textAlign:"center",padding:"40px 0"},children:[r.jsx(w,{style:{fontSize:"48px",color:"#8c8c8c",marginBottom:"16px"}}),r.jsx(Ae,{level:4,style:{color:"#8c8c8c"},children:"等待开始"}),r.jsx(De,{type:"secondary",children:"计算引擎准备就绪，等待任务开始"})]})]})};export{xe as A,ue as B,me as C,he as D,M as E,q as F,U as G,J as H,Oe as I,Re as J,_e as K,Be as O,W as P,be as a,Z as b,Q as c,te as d,ee as e,fe as f,X as g,re as h,ne as i,se as j,le as k,ae as l,Ne as m,de as n,ce as o,Ce as p,ie as q,oe as r,pe as s,G as t,R as u,Fe as v,je as w,ve as x,$e as y,ye as z};
