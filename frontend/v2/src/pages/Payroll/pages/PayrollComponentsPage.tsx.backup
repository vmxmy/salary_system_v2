import React, { useEffect, useState, useRef, useCallback, useMemo } from 'react';
import { Space, Button, Modal, Form, Input, Select, Switch, Popconfirm, Card, Typography, Row, Col, Divider, Tag, InputNumber, App } from 'antd';
import type { InputRef } from 'antd';
import { PlusOutlined, EditOutlined, DeleteOutlined, SearchOutlined, FilterFilled, DownloadOutlined, SettingOutlined, HomeOutlined } from '@ant-design/icons';
import { useTranslation } from 'react-i18next';
import { useTableExport, useColumnControl } from '../../../components/common/TableUtils';
import PageLayout from '../../../components/common/PageLayout';
import * as payrollApi from '../services/payrollApi';
import * as configApi from '../../../api/config';
import type { LookupValue } from '../../../api/types';
import type { PayrollComponentDefinition } from '../types/payrollTypes';
import EnhancedProTable from '../../../components/common/EnhancedProTable';
import type { ProColumns } from '@ant-design/pro-components';
import styles from './PayrollComponentsPage.module.less';

const { Title } = Typography;
const { Option } = Select;

// å†…è”PageHeaderç»„ä»¶å®šä¹‰
interface PageHeaderProps {
  /**
   * é¡µé¢æ ‡é¢˜
   */
  title: string;
  /**
   * å­æ ‡é¢˜æˆ–æè¿°æ–‡æœ¬
   */
  subtitle?: string;
  /**
   * é¢å¤–æ“ä½œæŒ‰é’®åŒºåŸŸ
   */
  extra?: React.ReactNode;
}

/**
 * é€šç”¨é¡µé¢å¤´éƒ¨ç»„ä»¶ï¼ŒåŒ…å«æ ‡é¢˜å’Œæ“ä½œæŒ‰é’®åŒºåŸŸ
 */
const PageHeader: React.FC<PageHeaderProps> = ({ title, subtitle, extra }) => {
  return (
    <Row justify="space-between" align="middle" style={{ marginBottom: 24 }}>
      <Col>
        <Space direction="vertical" size={4}>
          <Title level={4} style={{ margin: 0 }}>{title}</Title>
          {subtitle && <Typography.Text type="secondary">{subtitle}</Typography.Text>}
        </Space>
      </Col>
      {extra && (
        <Col>
          {extra}
        </Col>
      )}
    </Row>
  );
};

/**
 * è–ªèµ„å­—æ®µç®¡ç†é¡µé¢ç»„ä»¶
 */
const PayrollComponentsPage: React.FC = () => {
  const { t } = useTranslation(['payroll_components', 'common']);
  const { message } = App.useApp(); // ä½¿ç”¨ App.useApp() è·å– message å®ä¾‹
  const [loading, setLoading] = useState(false);
  const [components, setComponents] = useState<PayrollComponentDefinition[]>([]);
  const [modalVisible, setModalVisible] = useState(false);
  const [editingComponent, setEditingComponent] = useState<PayrollComponentDefinition | null>(null);
  const [form] = Form.useForm();
  const [componentTypes, setComponentTypes] = useState<string[]>([]);
  const [typeInfo, setTypeInfo] = useState<Record<string, { text: string, color: string }>>({});
  
  // åˆ†é¡µçŠ¶æ€
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 10,
    total: 0,
  });

  // è·å–ç±»å‹å¯¹åº”çš„ä¸­æ–‡åç§°å’Œé¢œè‰²
  const getTypeInfo = (type: string): { text: string; color: string } => {
    // å¦‚æœå·²ç»ä»lookupä¸­è·å–åˆ°äº†ç±»å‹ä¿¡æ¯ï¼Œåˆ™ä½¿ç”¨lookupä¸­çš„å€¼
    if (typeInfo[type]) {
      return typeInfo[type];
    }
    
    // é»˜è®¤å€¼
    let text = type;
    let color = 'default';
    
    // æ ¹æ®ç±»å‹è¿”å›å¯¹åº”çš„ä¸­æ–‡åç§°å’Œé¢œè‰²
    switch(type.toUpperCase()) {
      case 'EARNING':
        text = 'æ”¶å…¥é¡¹';
        color = 'green';
        break;
      case 'STAT':
      case 'STATUTORY':
        text = 'ç»Ÿè®¡é¡¹';
        color = 'blue';
        break;
      case 'DEDUCTION':
        text = 'æ‰£é™¤é¡¹';
        color = 'red';
        break;
      case 'EMPLOYER_DEDUCTION':
        text = 'å•ä½æ‰£é™¤é¡¹';
        color = 'orange';
        break;
      case 'PERSONAL_DEDUCTION':
        text = 'ä¸ªäººæ‰£é™¤é¡¹';
        color = 'purple';
        break;
      case 'BENEFIT':
        text = 'ç¦åˆ©é¡¹';
        color = 'cyan';
        break;
      case 'OTHER':
        text = 'å…¶ä»–';
        color = 'gray';
        break;
      default:
        // å…¼å®¹æ—§æ•°æ®
        if (type === 'Earning') {
          text = 'æ”¶å…¥é¡¹';
          color = 'green';
        } else if (type === 'Deduction') {
          text = 'æ‰£é™¤é¡¹';
          color = 'red';
        }
    }
    
    return { text, color };
  };

  // åŠ è½½è–ªèµ„å­—æ®µæ•°æ®
  const fetchComponents = async (page = 1, size = 10) => {
    setLoading(true);
    try {
      const response = await payrollApi.getPayrollComponentDefinitions({ 
        page, 
        size
      });
      setComponents(response.data);
      setPagination(prev => ({
        ...prev,
        current: page,
        pageSize: size,
        total: response.meta?.total || 0,
      }));
      
      // æå–æ‰€æœ‰å”¯ä¸€çš„ç±»å‹å€¼
      const uniqueTypes = Array.from(new Set(response.data.map(comp => comp.type)));
      setComponentTypes(uniqueTypes);
    } catch (error) {
      console.error('Error fetching payroll components:', error);
      message.error(t('common.error.fetch'));
    } finally {
      setLoading(false);
    }
  };

  // è·å–è–ªèµ„å­—æ®µç±»å‹
  const fetchComponentTypes = async () => {
    try {
      console.log('ğŸ”„ å¼€å§‹è·å–è–ªèµ„å­—æ®µç±»å‹...');
      const response = await configApi.getPayrollComponentTypes();
      console.log('âœ… è·å–è–ªèµ„å­—æ®µç±»å‹æˆåŠŸ:', response);
      
      const typesMap: Record<string, { text: string, color: string }> = {};
      
      response.data.forEach((type: any) => {
        const typeCode = type.code || type.value_code;
        const typeName = type.name || type.value_name;
        typesMap[typeCode] = {
          text: typeName,
          color: getTypeInfo(typeCode).color // ç»§ç»­ä½¿ç”¨ç°æœ‰çš„é¢œè‰²æ˜ å°„
        };
      });
      
      console.log('ğŸ“‹ å¤„ç†åçš„ç±»å‹æ˜ å°„:', typesMap);
      setTypeInfo(typesMap);
    } catch (error) {
      console.error('âŒ è·å–è–ªèµ„å­—æ®µç±»å‹å¤±è´¥:', error);
    }
  };

  useEffect(() => {
    fetchComponents();
    fetchComponentTypes();
  }, []);

  // æœç´¢è¾“å…¥æ¡†å¼•ç”¨
  const searchInput = useRef<InputRef>(null);

  // è·å–åˆ—æœç´¢å±æ€§
  const getColumnSearchProps = (dataIndex: keyof PayrollComponentDefinition) => ({
    filterDropdown: ({ setSelectedKeys, selectedKeys, confirm, clearFilters }: any) => (
      <div style={{ padding: 8 }}>
        <Input
          ref={searchInput}
          placeholder={t('common.search')}
          value={selectedKeys[0]}
          onChange={e => setSelectedKeys(e.target.value ? [e.target.value] : [])}
          onPressEnter={() => confirm()}
          style={{ marginBottom: 8, display: 'block' }}
        />
        <Space>
          <Button
            type="primary"
            onClick={() => confirm()}
            icon={<SearchOutlined />}
            size="small"
            style={{ width: 90 }}
          >
            {t('common.search')}
          </Button>
          <Button
            onClick={() => clearFilters && clearFilters()}
            size="small"
            style={{ width: 90 }}
          >
            {t('common.reset')}
          </Button>
        </Space>
      </div>
    ),
    filterIcon: (filtered: boolean) => (
      <SearchOutlined style={{ color: filtered ? '#1890ff' : undefined }} />
    ),
    onFilter: (value: any, record: PayrollComponentDefinition) => {
      const recordValue = record[dataIndex];
      return recordValue
        ? String(recordValue).toLowerCase().includes(String(value).toLowerCase())
        : false;
    },
    filterDropdownProps: {
      onOpenChange: (visible: boolean) => {
        if (visible) {
          setTimeout(() => searchInput.current?.select(), 100);
        }
      },
    },
  });

  // è¡¨æ ¼åˆ—å®šä¹‰
  const initialColumns: ProColumns<PayrollComponentDefinition>[] = [
    {
      title: t('payroll_components.code'),
      dataIndex: 'code',
      key: 'code',
      sorter: (a: PayrollComponentDefinition, b: PayrollComponentDefinition) =>
        a.code.localeCompare(b.code),
      ...getColumnSearchProps('code'),
    },
    {
      title: t('payroll_components.name'),
      dataIndex: 'name',
      key: 'name',
      sorter: (a: PayrollComponentDefinition, b: PayrollComponentDefinition) =>
        a.name.localeCompare(b.name),
      ...getColumnSearchProps('name'),
    },
    {
      title: t('payroll_components.type'),
      dataIndex: 'type',
      key: 'type',
      render: (_, record) => {
        const { text, color } = getTypeInfo(record.type);
        return <Tag color={color}>{text}</Tag>;
      },
      sorter: (a: PayrollComponentDefinition, b: PayrollComponentDefinition) =>
        a.type.localeCompare(b.type),
      filters: Object.entries(typeInfo).map(([typeCode, typeData]) => ({
        text: typeData.text,
        value: typeCode,
      })),
      onFilter: (value: any, record: PayrollComponentDefinition) => record.type === String(value),
    },
    {
      title: t('payroll_components.is_taxable'),
      dataIndex: 'is_taxable',
      key: 'is_taxable',
      render: (_, record) => (
        record.is_taxable ? t('common.yes') : t('common.no')
      ),
      sorter: (a: PayrollComponentDefinition, b: PayrollComponentDefinition) =>
        Number(a.is_taxable) - Number(b.is_taxable),
      filters: [
        { text: t('common.yes'), value: true },
        { text: t('common.no'), value: false },
      ],
      onFilter: (value: any, record: PayrollComponentDefinition) => record.is_taxable === value,
    },
    {
      title: t('payroll_components.sort_order'),
      dataIndex: 'sort_order',
      key: 'sort_order',
      sorter: (a: PayrollComponentDefinition, b: PayrollComponentDefinition) =>
        (a.sort_order || 0) - (b.sort_order || 0),
      filterDropdown: ({ setSelectedKeys, selectedKeys, confirm, clearFilters }: any) => (
        <div style={{ padding: 8 }}>
          <Space direction="vertical">
            <InputNumber
              placeholder={t('common.min')}
              value={selectedKeys[0]}
              onChange={val => setSelectedKeys(val ? [val] : [])}
              style={{ width: 120, marginRight: 8 }}
            />
            <InputNumber
              placeholder={t('common.max')}
              value={selectedKeys[1]}
              onChange={val => setSelectedKeys(selectedKeys[0] !== undefined ? [selectedKeys[0], val] : [])}
              style={{ width: 120, marginRight: 8 }}
            />
            <Space>
              <Button
                type="primary"
                onClick={() => confirm()}
                icon={<FilterFilled />}
                size="small"
                style={{ width: 90 }}
              >
                {t('common.filter')}
              </Button>
              <Button
                onClick={() => clearFilters && clearFilters()}
                size="small"
                style={{ width: 90 }}
              >
                {t('common.reset')}
              </Button>
            </Space>
          </Space>
        </div>
      ),
      filterIcon: (filtered: boolean) => (
        <FilterFilled style={{ color: filtered ? '#1890ff' : undefined }} />
      ),
      onFilter: (value: any, record: PayrollComponentDefinition) => {
        const selectedKeys = value as number[];
        const min = selectedKeys[0];
        const max = selectedKeys[1];
        const sortOrder = record.sort_order || 0;
        
        if (min !== undefined && max !== undefined) {
          return sortOrder >= min && sortOrder <= max;
        }
        if (min !== undefined) {
          return sortOrder >= min;
        }
        if (max !== undefined) {
          return sortOrder <= max;
        }
        return true;
      },
    },
    {
      title: t('common.status'),
      dataIndex: 'is_active',
      key: 'is_active',
      render: (_, record) => (
        <Tag color={record.is_active ? 'green' : 'red'}>
          {record.is_active ? t('common.active') : t('common.inactive')}
        </Tag>
      ),
      sorter: (a: PayrollComponentDefinition, b: PayrollComponentDefinition) =>
        Number(a.is_active) - Number(b.is_active),
      filters: [
        { text: t('common.active'), value: true },
        { text: t('common.inactive'), value: false },
      ],
      onFilter: (value: any, record: PayrollComponentDefinition) => record.is_active === value,
    },
    {
      title: t('common.actions'),
      key: 'actions',
      render: (_: any, record: PayrollComponentDefinition) => (
        <Space size="small">
          <Button 
            type="text" 
            icon={<EditOutlined />} 
            onClick={() => handleEdit(record)}
          />
          <Popconfirm
            title={t('common.confirmDelete')}
            onConfirm={() => handleDelete(record.id)}
            okText={t('common.yes')}
            cancelText={t('common.no')}
          >
            <Button 
              type="text" 
              danger 
              icon={<DeleteOutlined />} 
            />
          </Popconfirm>
        </Space>
      ),
    },
  ];

  // æš‚æ—¶ç¦ç”¨å¯¼å‡ºå’Œåˆ—æ§åˆ¶åŠŸèƒ½ï¼Œå› ä¸ºå®ƒä»¬ä¸ ProTable ä¸å…¼å®¹
  // const { ExportButton } = useTableExport(
  //   components,
  //   initialColumns,
  //   {
  //     filename: t('payroll_components.export.filename', { ns: 'payroll_components' }),
  //     sheetName: t('payroll_components.export.sheet_name', { ns: 'payroll_components' }),
  //     buttonText: t('common:action.export'),
  //   }
  // );

  // const { ColumnControl, visibleColumns: controlledColumns } = useColumnControl(
  //   initialColumns,
  //   {
  //     storageKeyPrefix: 'payrollComponentsTable',
  //     buttonText: t('common:action.columns'),
  //     tooltipTitle: t('common:tooltip.column_settings')
  //   }
  // );

  // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
  const handleEdit = (component: PayrollComponentDefinition) => {
    setEditingComponent(component);
    form.setFieldsValue({
      ...component,
      type: component.type,
      is_active: component.is_active,
      is_taxable: component.is_taxable,
      is_social_security_base: component.is_social_security_base,
      is_housing_fund_base: component.is_housing_fund_base,
      sort_order: component.sort_order || 0,
    });
    setModalVisible(true);
  };

  // æ‰“å¼€æ·»åŠ æ¨¡æ€æ¡†
  const handleAdd = () => {
    setEditingComponent(null);
    form.resetFields();
    const defaultType = Object.keys(typeInfo).length > 0 ? Object.keys(typeInfo)[0] : 'EARNING';
    const today = new Date().toISOString().split('T')[0]; // æ ¼å¼åŒ–ä¸º YYYY-MM-DD
    form.setFieldsValue({
      type: defaultType,
      is_active: true,
      is_taxable: true,
      is_social_security_base: false,
      is_housing_fund_base: false,
      sort_order: 0,
      effective_date: today,
    });
    setModalVisible(true);
  };

  // å¤„ç†æ¨¡æ€æ¡†ç¡®è®¤
  const handleModalOk = async () => {
    let values: any = null;
    
    try {
      values = await form.validateFields();
      
      // æ˜ å°„å‰ç«¯å­—æ®µååˆ°åç«¯æœŸæœ›çš„å­—æ®µå
      const mappedValues = {
        ...values,
        display_order: values.sort_order, // åç«¯æœŸæœ› display_orderï¼Œå‰ç«¯ä½¿ç”¨ sort_order
      };
      
      // ç§»é™¤å‰ç«¯ç‰¹æœ‰çš„å­—æ®µ
      delete mappedValues.sort_order;
      
      console.log('æäº¤çš„æ•°æ®:', mappedValues);
      
      if (editingComponent) {
        // æ›´æ–°
        await payrollApi.updatePayrollComponentDefinition(editingComponent.id, mappedValues);
        message.success(t('payroll_components.update_success'));
      } else {
        // åˆ›å»º
        await payrollApi.createPayrollComponentDefinition(mappedValues);
        message.success(t('payroll_components.create_success'));
      }
      
      setModalVisible(false);
      fetchComponents(pagination.current, pagination.pageSize);
    } catch (error: any) {
      console.error('Form validation failed or API error:', error);
      
      // å¤„ç†ä¸åŒç±»å‹çš„é”™è¯¯
      let errorMessage = editingComponent 
        ? t('payroll_components.update_failed') 
        : t('payroll_components.create_failed');
      
      if (error.response?.status === 422) {
        // å¤„ç†422é”™è¯¯ï¼ˆæ•°æ®éªŒè¯é”™è¯¯ï¼‰
        const errorDetail = error.response?.data?.detail;
        if (typeof errorDetail === 'string') {
          errorMessage = errorDetail;
        } else if (errorDetail?.error?.details) {
          errorMessage = errorDetail.error.details;
        } else if (errorDetail?.details) {
          errorMessage = errorDetail.details;
        } else {
          // æ£€æŸ¥æ˜¯å¦æ˜¯ç¼–ç é‡å¤é”™è¯¯
          const errorText = JSON.stringify(error.response.data).toLowerCase();
          if (errorText.includes('å·²å­˜åœ¨') || errorText.includes('duplicate') || errorText.includes('unique')) {
            errorMessage = values?.code 
              ? `ç¼–ç  "${values.code}" å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨ä¸åŒçš„ç¼–ç `
              : 'ç¼–ç å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨ä¸åŒçš„ç¼–ç ';
          }
        }
      } else if (error.response?.status === 400) {
        // å¤„ç†400é”™è¯¯ï¼ˆè¯·æ±‚é”™è¯¯ï¼‰
        errorMessage = 'è¯·æ±‚æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥å†…å®¹';
      } else if (error.response?.status === 500) {
        // å¤„ç†500é”™è¯¯ï¼ˆæœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼‰
        errorMessage = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜';
      } else if (error.message) {
        // ä½¿ç”¨é”™è¯¯æ¶ˆæ¯
        errorMessage = error.message;
      }
      
      message.error(errorMessage);
    }
  };

  // å¤„ç†åˆ é™¤
  const handleDelete = async (id: number) => {
    try {
      await payrollApi.deletePayrollComponentDefinition(id);
      message.success(t('payroll_components.delete_success'));
      fetchComponents(pagination.current, pagination.pageSize);
    } catch (error) {
      console.error('Error deleting component:', error);
      message.error(t('common.error.delete'));
    }
  };



  return (
    <PageLayout
      title={t('payroll_components.title')}
      actions={
        <Space className={styles.actionButtons}>
          <Button
            type="primary"
            icon={<PlusOutlined />}
            onClick={handleAdd}
          >
            {t('payroll_components.add')}
          </Button>
          {/* {ExportButton && <ExportButton />} */}
          {/* {ColumnControl && <ColumnControl />} */}
        </Space>
      }
    >
      <div className={styles.tableContainer}>
        <EnhancedProTable<PayrollComponentDefinition>
          dataSource={components}
          columns={initialColumns}
          rowKey="id"
          loading={loading}
          pagination={{
            current: pagination.current,
            pageSize: pagination.pageSize,
            total: pagination.total,
            showSizeChanger: true,
            showQuickJumper: true,
            showTotal: (total: number, range: [number, number]) => 
              `ç¬¬ ${range[0]}-${range[1]} æ¡ï¼Œå…± ${total} æ¡`,
            onChange: (page: number, size?: number) => {
              fetchComponents(page, size || pagination.pageSize);
            },
            onShowSizeChange: (current: number, size: number) => {
              fetchComponents(1, size);
            },
          }}
        />
      </div>

      {/* ç¼–è¾‘/æ·»åŠ æ¨¡æ€æ¡† */}
      <Modal
        title={editingComponent ? t('payroll_components.edit') : t('payroll_components.add')}
        open={modalVisible}
        onOk={handleModalOk}
        onCancel={() => setModalVisible(false)}
        width={700}
      >
        <Form
          form={form}
          layout="vertical"
        >
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="code"
                label={t('payroll_components.code')}
                rules={[{ required: true, message: t('common.validation.required') }]}
              >
                <Input disabled={!!editingComponent} />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="name"
                label={t('payroll_components.name')}
                rules={[{ required: true, message: t('common.validation.required') }]}
              >
                <Input />
              </Form.Item>
            </Col>
          </Row>

          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="type"
                label={t('payroll_components.type')}
                rules={[{ required: true, message: t('common.validation.required') }]}
              >
                <Select>
                  {Object.keys(typeInfo).length > 0 ? (
                    Object.entries(typeInfo).map(([typeCode, typeData]) => (
                      <Option key={typeCode} value={typeCode}>{typeData.text}</Option>
                    ))
                  ) : (
                    <>
                      <Option value="EARNING">æ”¶å…¥é¡¹</Option>
                      <Option value="DEDUCTION">æ‰£é™¤é¡¹</Option>
                    </>
                  )}
                </Select>
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="sort_order"
                label={t('payroll_components.sort_order')}
                rules={[{ required: true, message: t('common.validation.required') }]}
              >
                <Input type="number" min={0} />
              </Form.Item>
            </Col>
          </Row>

          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="effective_date"
                label="ç”Ÿæ•ˆæ—¥æœŸ"
                rules={[{ required: true, message: t('common.validation.required') }]}
              >
                <Input type="date" />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="end_date"
                label="ç»“æŸæ—¥æœŸ"
              >
                <Input type="date" />
              </Form.Item>
            </Col>
          </Row>

          <Divider>{t('payroll_components.options')}</Divider>

          <Row gutter={16}>
            <Col span={8}>
              <Form.Item
                name="is_active"
                label={t('common.status')}
                valuePropName="checked"
              >
                <Switch checkedChildren={t('common.active')} unCheckedChildren={t('common.inactive')} />
              </Form.Item>
            </Col>
            <Col span={8}>
              <Form.Item
                name="is_taxable"
                label={t('payroll_components.is_taxable')}
                valuePropName="checked"
              >
                <Switch />
              </Form.Item>
            </Col>
            <Col span={8}>
              <Form.Item
                name="is_social_security_base"
                label={t('payroll_components.is_social_security_base')}
                valuePropName="checked"
              >
                <Switch />
              </Form.Item>
            </Col>
          </Row>

          <Row gutter={16}>
            <Col span={8}>
              <Form.Item
                name="is_housing_fund_base"
                label={t('payroll_components.is_housing_fund_base')}
                valuePropName="checked"
              >
                <Switch />
              </Form.Item>
            </Col>
            <Col span={16}>
              <Form.Item
                name="description"
                label={t('common.description')}
              >
                <Input.TextArea rows={2} />
              </Form.Item>
            </Col>
          </Row>
        </Form>
      </Modal>
    </PageLayout>
  );
};

export default PayrollComponentsPage; 